// Prisma Schema para CRM - FrascoLife
// CRM Completo estilo Salesforce

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MÓDULO: USUÁRIOS E PERMISSÕES
// ============================================

model User {
  id            String    @id @default(cuid())
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Dados básicos (Supabase Auth)
  supabaseId    String    @unique @map("supabase_id")
  email         String    @unique
  fullName      String?   @map("full_name")
  avatar        String?
  phone         String?

  // Permissões e Acesso
  role          UserRole  @default(SALES_REP)
  teamId        String?   @map("team_id")
  team          Team?     @relation(fields: [teamId], references: [id])
  isActive      Boolean   @default(true) @map("is_active")
  lastLoginAt   DateTime? @map("last_login_at")

  // Relacionamentos
  assignedLeads     Lead[]
  activities        Activity[]
  calls             Call[]
  emails            Email[]
  whatsappMessages  WhatsAppMessage[]
  tasks             Task[]
  notes             Note[]
  campaigns         Campaign[]
  assignedOpportunities Opportunity[]
  pipelineOpportunities PipelineOpportunity[] @relation("PipelineOpportunityOwner")
  pipelineHistory   PipelineStageHistory[] @relation("PipelineHistoryMover")

  @@index([supabaseId])
  @@index([teamId])
  @@index([role])
  @@map("users")
}

enum UserRole {
  ADMIN           // Acesso total
  MANAGER         // Gerente de equipe
  SALES_REP       // Vendedor
  SDR             // Sales Development Rep
  VIEWER          // Apenas visualização
}

model Team {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  name        String
  description String?
  color       String?  // Para UI

  members     User[]
  campaigns   Campaign[]

  @@map("teams")
}

// ============================================
// MÓDULO: LEADS E CONTAS
// ============================================

model Lead {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Dados da Empresa (CNPJ)
  cnpj              String   @unique @db.Text
  cnpjBase          String   @db.Text
  cnpjOrder         String   @db.Text
  cnpjDv            String   @db.Text
  razaoSocial       String?  @db.Text
  nomeFantasia      String?  @db.Text
  situacaoCadastral String   @db.Text
  cnaePrincipal     String?  @db.Text
  cnaeSecundario    String?  @db.Text
  cnaesSecundarios  String?  @db.Text @map("cnaes_secundarios")
  porte             String?  @db.Text
  naturezaJuridica  String?  @db.Text @map("natureza_juridica")
  capitalSocial     String?  @db.Text @map("capital_social")
  dataAbertura      String?  @db.Text
  dataSituacao      String?  @db.Text
  dataSituacaoCadastral String? @db.Text @map("data_situacao_cadastral")
  matrizFilial      String   @db.Text

  // Endereço
  tipoLogradouro    String?  @db.Text
  logradouro        String?  @db.Text
  numero            String?  @db.Text
  complemento       String?  @db.Text
  bairro            String?  @db.Text
  cep               String?  @db.Text
  municipio         String?  @db.Text
  uf                String?  @db.Text

  // Contato Empresa
  ddd1              String?  @db.Text
  telefone1         String?  @db.Text
  ddd2              String?  @db.Text
  telefone2         String?  @db.Text
  dddFax            String?  @db.Text
  fax               String?  @db.Text
  email             String?  @db.Text

  // CRM Fields (NOVOS)
  stage         LeadStage    @default(NEW)
  score         Int          @default(0)        // 0-100
  source        LeadSource   @default(MANUAL)

  // Relacionamento com vendedor
  assignedToId  String?   @map("assigned_to_id")
  assignedTo    User?     @relation(fields: [assignedToId], references: [id])
  assignedAt    DateTime? @map("assigned_at")

  // Contato Principal (Pessoa)
  contactName       String?  @db.Text @map("contact_name")
  contactRole       String?  @db.Text @map("contact_role")
  contactPhone      String?  @db.Text @map("contact_phone")
  contactEmail      String?  @db.Text @map("contact_email")
  contactLinkedIn   String?  @db.Text @map("contact_linked_in")

  // Qualificação
  isQualified       Boolean   @default(false) @map("is_qualified")
  qualifiedAt       DateTime? @map("qualified_at")
  disqualifiedReason String? @db.Text @map("disqualified_reason")

  // Estimativas
  estimatedRevenue  Decimal?  @db.Decimal(12, 2) @map("estimated_revenue")
  estimatedCloseDate DateTime? @map("estimated_close_date")
  probability       Int?      // 0-100%

  // Relacionamentos
  activities        Activity[]
  calls             Call[]
  emails            Email[]
  whatsappMessages  WhatsAppMessage[]
  tasks             Task[]
  notes             Note[]
  tags              LeadTag[]
  opportunities     Opportunity[]
  campaignLeads     CampaignLead[]
  pipelineOpportunities PipelineOpportunity[]

  @@index([stage])
  @@index([assignedToId])
  @@index([score])
  @@index([uf])
  @@index([cnaePrincipal])
  @@index([situacaoCadastral])
  @@index([matrizFilial])
  @@index([municipio])
  @@index([cnpjBase])
  @@map("leads")
}

enum LeadStage {
  NEW              // Novo lead
  CONTACTED        // Já foi contatado
  QUALIFIED        // Qualificado
  PROPOSAL         // Proposta enviada
  NEGOTIATION      // Em negociação
  WON              // Ganho
  LOST             // Perdido
  NURTURING        // Nutrição
}

enum LeadSource {
  MANUAL           // Adicionado manualmente
  IMPORT           // Importação CSV
  API              // Via API
  WEBSITE          // Site/Landing page
  REFERRAL         // Indicação
  COLD_CALL        // Cold calling
  EVENT            // Evento/Feira
  SOCIAL_MEDIA     // Redes sociais
}

// ============================================
// MÓDULO: PIPELINE E OPORTUNIDADES
// ============================================

model Opportunity {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  name        String   @db.Text
  description String?  @db.Text

  leadId      String   @map("lead_id")
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  stage       OpportunityStage @default(PROSPECTING)
  probability Int      @default(10)

  value       Decimal  @db.Decimal(12, 2)
  expectedCloseDate DateTime? @map("expected_close_date")
  closedAt    DateTime? @map("closed_at")
  wonReason   String?  @db.Text @map("won_reason")
  lostReason  String?  @db.Text @map("lost_reason")

  assignedToId String?  @map("assigned_to_id")
  assignedTo   User?    @relation(fields: [assignedToId], references: [id])

  products    OpportunityProduct[]
  activities  Activity[]

  @@index([leadId])
  @@index([stage])
  @@index([assignedToId])
  @@map("opportunities")
}

enum OpportunityStage {
  PROSPECTING
  QUALIFICATION
  NEEDS_ANALYSIS
  VALUE_PROPOSITION
  DECISION_MAKERS
  PROPOSAL
  NEGOTIATION
  CLOSED_WON
  CLOSED_LOST
}

model Product {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  name        String   @db.Text
  description String?  @db.Text
  sku         String?  @unique
  price       Decimal  @db.Decimal(12, 2)
  isActive    Boolean  @default(true) @map("is_active")

  opportunities OpportunityProduct[]

  @@map("products")
}

model OpportunityProduct {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now()) @map("created_at")

  opportunityId String      @map("opportunity_id")
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  productId     String  @map("product_id")
  product       Product @relation(fields: [productId], references: [id])

  quantity      Int     @default(1)
  unitPrice     Decimal @db.Decimal(12, 2) @map("unit_price")
  discount      Decimal @default(0) @db.Decimal(5, 2)
  total         Decimal @db.Decimal(12, 2)

  @@unique([opportunityId, productId])
  @@map("opportunity_products")
}

// ============================================
// MÓDULO: ATIVIDADES E TIMELINE
// ============================================

model Activity {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now()) @map("created_at")

  type        ActivityType
  title       String   @db.Text
  description String?  @db.Text

  leadId      String?      @map("lead_id")
  lead        Lead?        @relation(fields: [leadId], references: [id], onDelete: Cascade)

  opportunityId String?    @map("opportunity_id")
  opportunity   Opportunity? @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  userId      String       @map("user_id")
  user        User         @relation(fields: [userId], references: [id])

  metadata    Json?

  @@index([leadId])
  @@index([opportunityId])
  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("activities")
}

enum ActivityType {
  CALL
  EMAIL
  WHATSAPP
  MEETING
  NOTE
  TASK_COMPLETED
  STAGE_CHANGED
  ASSIGNED
  STATUS_CHANGED
}

// ============================================
// MÓDULO: COMUNICAÇÃO - CHAMADAS
// ============================================

model Call {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  leadId      String   @map("lead_id")
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id])

  direction   CallDirection
  status      CallStatus
  duration    Int?
  startedAt   DateTime? @map("started_at")
  endedAt     DateTime? @map("ended_at")

  twilioCallSid String? @unique @map("twilio_call_sid")
  fromNumber    String  @db.Text @map("from_number")
  toNumber      String  @db.Text @map("to_number")

  recordingUrl  String?  @db.Text @map("recording_url")
  recordingSid  String?  @db.Text @map("recording_sid")

  transcription String?  @db.Text
  summary       String?  @db.Text
  sentiment     Sentiment?
  keywords      String[]

  notes         String?  @db.Text
  outcome       CallOutcome?

  @@index([leadId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("calls")
}

enum CallDirection {
  INBOUND
  OUTBOUND
}

enum CallStatus {
  INITIATED
  RINGING
  IN_PROGRESS
  COMPLETED
  FAILED
  BUSY
  NO_ANSWER
  CANCELED
}

enum CallOutcome {
  INTERESTED
  NOT_INTERESTED
  CALLBACK
  WRONG_NUMBER
  VOICEMAIL
  MEETING_SCHEDULED
}

enum Sentiment {
  POSITIVE
  NEUTRAL
  NEGATIVE
}

// ============================================
// MÓDULO: COMUNICAÇÃO - EMAIL
// ============================================

model Email {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  leadId      String   @map("lead_id")
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id])

  direction   EmailDirection
  subject     String   @db.Text
  body        String   @db.Text
  htmlBody    String?  @db.Text @map("html_body")

  fromEmail   String   @db.Text @map("from_email")
  toEmail     String   @db.Text @map("to_email")
  ccEmails    String[] @map("cc_emails")
  bccEmails   String[] @map("bcc_emails")

  status      EmailStatus @default(DRAFT)
  sentAt      DateTime? @map("sent_at")
  deliveredAt DateTime? @map("delivered_at")
  openedAt    DateTime? @map("opened_at")
  clickedAt   DateTime? @map("clicked_at")
  bouncedAt   DateTime? @map("bounced_at")

  opens       Int      @default(0)
  clicks      Int      @default(0)

  messageId   String?  @unique @map("message_id")
  templateId  String?  @db.Text @map("template_id")

  attachments EmailAttachment[]

  @@index([leadId])
  @@index([userId])
  @@index([status])
  @@index([sentAt])
  @@map("emails")
}

enum EmailDirection {
  INBOUND
  OUTBOUND
}

enum EmailStatus {
  DRAFT
  SCHEDULED
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  FAILED
}

model EmailAttachment {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now()) @map("created_at")

  emailId     String @map("email_id")
  email       Email  @relation(fields: [emailId], references: [id], onDelete: Cascade)

  filename    String @db.Text
  filesize    Int
  contentType String @db.Text @map("content_type")
  url         String   @db.Text

  @@index([emailId])
  @@map("email_attachments")
}

model EmailTemplate {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  name        String   @db.Text
  subject     String   @db.Text
  body        String   @db.Text
  htmlBody    String?  @db.Text

  category    String?  @db.Text
  isActive    Boolean  @default(true)

  variables   String[]

  @@map("email_templates")
}

// ============================================
// MÓDULO: COMUNICAÇÃO - WHATSAPP
// ============================================

model WhatsAppMessage {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  leadId      String   @map("lead_id")
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  userId      String?  @map("user_id")
  user        User?    @relation(fields: [userId], references: [id])

  direction   MessageDirection
  content     String   @db.Text
  contentType MessageContentType @default(TEXT) @map("content_type")

  fromNumber  String   @db.Text @map("from_number")
  toNumber    String   @db.Text @map("to_number")

  status      MessageStatus @default(PENDING)
  sentAt      DateTime?     @map("sent_at")
  deliveredAt DateTime?     @map("delivered_at")
  readAt      DateTime?     @map("read_at")
  failedAt    DateTime?     @map("failed_at")

  twilioMessageSid String? @unique @map("twilio_message_sid")
  errorMessage     String? @db.Text @map("error_message")

  mediaUrl    String?  @db.Text @map("media_url")

  @@index([leadId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("whatsapp_messages")
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageContentType {
  TEXT
  IMAGE
  DOCUMENT
  AUDIO
  VIDEO
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

model WhatsAppTemplate {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  name        String   @db.Text
  content     String   @db.Text
  category    String?  @db.Text
  isActive    Boolean  @default(true)

  twilioSid   String?  @unique @map("twilio_sid")

  @@map("whatsapp_templates")
}

// ============================================
// MÓDULO: TAREFAS E FOLLOW-UPS
// ============================================

model Task {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  title       String   @db.Text
  description String?  @db.Text

  leadId      String?  @map("lead_id")
  lead        Lead?    @relation(fields: [leadId], references: [id], onDelete: Cascade)

  assignedToId String       @map("assigned_to_id")
  assignedTo   User         @relation(fields: [assignedToId], references: [id])

  dueDate     DateTime      @map("due_date")
  priority    TaskPriority  @default(MEDIUM)
  status      TaskStatus    @default(TODO)

  completedAt DateTime?     @map("completed_at")
  completedBy String?  @db.Text @map("completed_by")

  reminders   TaskReminder[]

  @@index([leadId])
  @@index([assignedToId])
  @@index([status])
  @@index([dueDate])
  @@map("tasks")
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
  CANCELED
}

model TaskReminder {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now()) @map("created_at")

  taskId      String         @map("task_id")
  task        Task           @relation(fields: [taskId], references: [id], onDelete: Cascade)

  remindAt    DateTime       @map("remind_at")
  method      ReminderMethod @default(EMAIL)
  sent        Boolean        @default(false)
  sentAt      DateTime?      @map("sent_at")

  @@index([taskId])
  @@index([remindAt])
  @@map("task_reminders")
}

enum ReminderMethod {
  EMAIL
  NOTIFICATION
  WHATSAPP
}

// ============================================
// MÓDULO: NOTAS
// ============================================

model Note {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  content     String   @db.Text

  leadId      String   @map("lead_id")
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  createdById String  @map("created_by_id")
  createdBy   User    @relation(fields: [createdById], references: [id])

  isPinned    Boolean @default(false) @map("is_pinned")

  @@index([leadId])
  @@index([createdById])
  @@index([createdAt])
  @@map("notes")
}

// ============================================
// MÓDULO: TAGS E SEGMENTAÇÃO
// ============================================

model Tag {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now()) @map("created_at")

  name        String   @unique
  color       String   @db.Text
  icon        String?  @db.Text

  leads       LeadTag[]

  @@map("tags")
}

model LeadTag {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now()) @map("created_at")

  leadId      String   @map("lead_id")
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  tagId       String @map("tag_id")
  tag         Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([leadId, tagId])
  @@index([leadId])
  @@index([tagId])
  @@map("lead_tags")
}

// ============================================
// MÓDULO: CAMPANHAS
// ============================================

model Campaign {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  name        String   @db.Text
  description String?  @db.Text

  type        CampaignType
  status      CampaignStatus @default(DRAFT)

  startDate   DateTime? @map("start_date")
  endDate     DateTime? @map("end_date")

  ownerId     String    @map("owner_id")
  owner       User      @relation(fields: [ownerId], references: [id])

  teamId      String?   @map("team_id")
  team        Team?     @relation(fields: [teamId], references: [id])

  filters     Json?

  totalLeads      Int @default(0) @map("total_leads")
  contactedLeads  Int @default(0) @map("contacted_leads")
  qualifiedLeads  Int @default(0) @map("qualified_leads")
  wonLeads        Int @default(0) @map("won_leads")

  leads       CampaignLead[]

  @@index([ownerId])
  @@index([teamId])
  @@index([status])
  @@map("campaigns")
}

enum CampaignType {
  COLD_CALL
  EMAIL
  WHATSAPP
  MULTI_CHANNEL
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  PAUSED
  COMPLETED
  CANCELED
}

model CampaignLead {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  campaignId  String   @map("campaign_id")
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  leadId      String   @map("lead_id")
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  status      CampaignLeadStatus @default(PENDING)
  priority    Int      @default(0)

  contactedAt DateTime? @map("contacted_at")
  respondedAt DateTime? @map("responded_at")
  outcome     String?  @db.Text

  @@unique([campaignId, leadId])
  @@index([campaignId])
  @@index([leadId])
  @@index([status])
  @@map("campaign_leads")
}

enum CampaignLeadStatus {
  PENDING
  CONTACTED
  RESPONDED
  QUALIFIED
  CONVERTED
  SKIPPED
}

// ============================================
// MÓDULO: PIPELINES CUSTOMIZÁVEIS
// ============================================

model Pipeline {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  name        String   @db.Text
  description String?  @db.Text
  isDefault   Boolean  @default(false) @map("is_default")
  isActive    Boolean  @default(true) @map("is_active")

  // Tipo de pipeline
  type        PipelineType @default(SALES)

  // Configurações
  settings    Json?    // Configurações específicas (ex: campos obrigatórios, automações)

  stages      PipelineStage[]
  opportunities PipelineOpportunity[]

  @@index([type])
  @@index([isDefault])
  @@map("pipelines")
}

enum PipelineType {
  SALES       // Pipeline de vendas
  LEADS       // Pipeline de leads
  CUSTOM      // Pipeline customizado
}

model PipelineStage {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  pipelineId  String   @map("pipeline_id")
  pipeline    Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)

  name        String   @db.Text
  description String?  @db.Text
  color       String   @default("#6B7280") @db.Text  // Cor hexadecimal
  icon        String?  @db.Text                      // Nome do ícone lucide

  // Ordenação e probabilidade
  order       Int      // Ordem de exibição
  probability Int      @default(0)  // 0-100%

  // Configurações
  isActive    Boolean  @default(true) @map("is_active")
  isFinal     Boolean  @default(false) @map("is_final")  // Se é estágio final (won/lost)

  // Rotting (oportunidades esquecidas)
  rottingDays Int?     @map("rotting_days")  // Dias até considerar "rotting"

  opportunities PipelineOpportunity[]

  @@unique([pipelineId, order])
  @@index([pipelineId])
  @@index([order])
  @@map("pipeline_stages")
}

model PipelineOpportunity {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  pipelineId  String   @map("pipeline_id")
  pipeline    Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)

  stageId     String   @map("stage_id")
  stage       PipelineStage @relation(fields: [stageId], references: [id])

  leadId      String   @map("lead_id")
  lead        Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // Dados da oportunidade
  title       String   @db.Text
  description String?  @db.Text
  value       Decimal  @default(0) @db.Decimal(12, 2)  // Valor estimado

  // Datas importantes
  expectedCloseDate DateTime? @map("expected_close_date")
  enteredStageAt    DateTime  @default(now()) @map("entered_stage_at")

  // Responsável
  ownerId     String?  @map("owner_id")
  owner       User?    @relation("PipelineOpportunityOwner", fields: [ownerId], references: [id])

  // Resultado final
  closedAt    DateTime? @map("closed_at")
  closedReason String?  @db.Text @map("closed_reason")

  // Analytics
  customFields Json?   @map("custom_fields")  // Campos customizados

  @@index([pipelineId])
  @@index([stageId])
  @@index([leadId])
  @@index([ownerId])
  @@index([expectedCloseDate])
  @@map("pipeline_opportunities")
}

// Histórico de movimentações no pipeline
model PipelineStageHistory {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now()) @map("created_at")

  opportunityId String  @map("opportunity_id")

  fromStageId String?  @map("from_stage_id")
  toStageId   String   @map("to_stage_id")

  movedById   String   @map("moved_by_id")
  movedBy     User     @relation("PipelineHistoryMover", fields: [movedById], references: [id])

  duration    Int?     // Tempo em dias no estágio anterior
  notes       String?  @db.Text

  @@index([opportunityId])
  @@index([toStageId])
  @@index([createdAt])
  @@map("pipeline_stage_history")
}
